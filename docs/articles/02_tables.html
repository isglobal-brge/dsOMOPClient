<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>2. Retrieving tables from the database • dsOMOPClient</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/Source_Sans_Pro-0.4.9/font.css" rel="stylesheet">
<link href="../deps/Source_Code_Pro-0.4.9/font.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="2. Retrieving tables from the database">
</head>
<body>
    <a href="#container" class="visually-hidden-focusable">Skip to content</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-none" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">dsOMOPClient</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.1.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/01_object.html">1. Creating an interface object</a></li>
    <li><a class="dropdown-item" href="../articles/02_tables.html">2. Retrieving tables from the database</a></li>
    <li><a class="dropdown-item" href="../articles/03_integration.html">3. Integrating data into the workflow</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article" id="container">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>2. Retrieving tables from the database</h1>
            
      

      <div class="d-none name"><code>02_tables.Rmd</code></div>
    </div>

    
    
<p>We have already seen how to create an interface object for an OMOP
CDM database. Now, let’s see how to use it to retrieve tables from it in
deeper detail. For this purpose, we will use the <code>get</code> method
of the interface object. This method has several arguments that allow
filtering the data that is retrieved and customizing the output.</p>
<div class="section level2">
<h2 id="features-of-the-get-method">2.1 Features of the <code>get</code> method<a class="anchor" aria-label="anchor" href="#features-of-the-get-method"></a>
</h2>
<div class="section level3">
<h3 id="table-reshaping">2.1.1 Table reshaping<a class="anchor" aria-label="anchor" href="#table-reshaping"></a>
</h3>
<p>The <code>get</code> method is an smart method that returns the table
after subjecting it to a series of operations. If it detects that this
table can present various records linked to the same OMOP CDM entity
(for example, to a <code>Person</code>), it will transform the table
into a wide format automatically using the in-built DataSHIELD reshape
function, ready to be merged with other tables. For instance, when we
take the <code>Person</code> table, it will return a table without
altering its original format:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">o</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span><span class="st">"person"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ds.summary</span><span class="op">(</span><span class="st">"person"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## $opal_demo</span></span>
<span><span class="co">## $opal_demo$class</span></span>
<span><span class="co">## [1] "data.frame"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $opal_demo$`number of rows`</span></span>
<span><span class="co">## [1] 100</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $opal_demo$`number of columns`</span></span>
<span><span class="co">## [1] 11</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $opal_demo$`variables held`</span></span>
<span><span class="co">##  [1] "person_id"            "gender_concept_id"    "year_of_birth"       </span></span>
<span><span class="co">##  [4] "month_of_birth"       "day_of_birth"         "birth_datetime"      </span></span>
<span><span class="co">##  [7] "race_concept_id"      "ethnicity_concept_id" "location_id"         </span></span>
<span><span class="co">## [10] "provider_id"          "care_site_id"</span></span></code></pre>
<p>Whereas if we take the <code>Measurement</code> table, which has
records potentially linkable to the <code>Person</code> table, it will
return a table in wide format, preserving the column
<code>person_id</code> so that it can be merged with the
<code>Person</code> table:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># 3027018 is the concept ID for `Heart rate`</span></span>
<span><span class="va">o</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span>table <span class="op">=</span> <span class="st">"measurement"</span>, conceptFilter <span class="op">=</span> <span class="fl">3027018</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ds.summary</span><span class="op">(</span><span class="st">"measurement"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## $opal_demo</span></span>
<span><span class="co">## $opal_demo$class</span></span>
<span><span class="co">## [1] "data.frame"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $opal_demo$`number of rows`</span></span>
<span><span class="co">## [1] 100</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $opal_demo$`number of columns`</span></span>
<span><span class="co">## [1] 15</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $opal_demo$`variables held`</span></span>
<span><span class="co">##  [1] "person_id"                             </span></span>
<span><span class="co">##  [2] "heart_rate.measurement_id"             </span></span>
<span><span class="co">##  [3] "heart_rate.measurement_date"           </span></span>
<span><span class="co">##  [4] "heart_rate.measurement_datetime"       </span></span>
<span><span class="co">##  [5] "heart_rate.measurement_time"           </span></span>
<span><span class="co">##  [6] "heart_rate.measurement_type_concept_id"</span></span>
<span><span class="co">##  [7] "heart_rate.operator_concept_id"        </span></span>
<span><span class="co">##  [8] "heart_rate.value_as_number"            </span></span>
<span><span class="co">##  [9] "heart_rate.value_as_concept_id"        </span></span>
<span><span class="co">## [10] "heart_rate.unit_concept_id"            </span></span>
<span><span class="co">## [11] "heart_rate.range_low"                  </span></span>
<span><span class="co">## [12] "heart_rate.range_high"                 </span></span>
<span><span class="co">## [13] "heart_rate.provider_id"                </span></span>
<span><span class="co">## [14] "heart_rate.visit_occurrence_id"        </span></span>
<span><span class="co">## [15] "heart_rate.visit_detail_id"</span></span></code></pre>
</div>
<div class="section level3">
<h3 id="concept-translation">2.1.2 Concept translation<a class="anchor" aria-label="anchor" href="#concept-translation"></a>
</h3>
<p>Another feature you may have noticed in the previous example is that
the <code>get</code> method automatically translates the concepts of the
table that we are retrieving. For instance, in the case of the
<code>Measurement</code> table, the concept <code>3027018</code> was
translated to <code>Heart rate</code>.</p>
<p>The same happens with the values of the rows in the tables. For
example, in the <code>Person</code> table, in the
<code>gender_concept_id</code> column, the value <code>8532</code> was
translated automatically to <code>FEMALE</code>, and the value
<code>8507</code> was translated to <code>MALE</code>:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">ds.summary</span><span class="op">(</span><span class="st">"person$gender_concept_id"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## $opal_demo</span></span>
<span><span class="co">## $opal_demo$class</span></span>
<span><span class="co">## [1] "factor"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $opal_demo$length</span></span>
<span><span class="co">## [1] 100</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $opal_demo$categories</span></span>
<span><span class="co">## [1] "female" "male"  </span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $opal_demo$`count of 'female'`</span></span>
<span><span class="co">## [1] 43</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $opal_demo$`count of 'male'`</span></span>
<span><span class="co">## [1] 57</span></span></code></pre>
<p>This will happen with all concepts in the database as long as they
are recognized and properly named in the <code>Concept</code> table of
the database. Otherwise, the concept will remain as
<code>concept_id_</code> + the numeric value of the concept. For
example, if the concept <code>FEMALE</code> was not properly named in
the <code>Concept</code> table, it would remain as
<code>concept_id_8532</code> so that it can at least be identified.</p>
</div>
<div class="section level3">
<h3 id="longitudinal-data-sequencing">2.1.3 Longitudinal data sequencing<a class="anchor" aria-label="anchor" href="#longitudinal-data-sequencing"></a>
</h3>
<p>When you have multiple records for the same entity (e.g., a patient)
across time points, <code>dsOMOP</code> offers two parameters to
transform and align these data in a wide format:</p>
<ol style="list-style-type: decimal">
<li>
<strong><code>wideLongitudinal = TRUE</code></strong> reshapes
repeated measurements for each concept into extra columns, so each row
in your table corresponds to one entity (e.g., one patient).</li>
<li>
<strong><code>completeTimePoints = TRUE</code></strong> further
ensures that all entities share the same set of time points. Rows (and
columns) for missing measurements at particular dates are filled with
<code>NA</code>.</li>
</ol>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">o</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span></span>
<span>  table <span class="op">=</span> <span class="st">"measurement"</span>,</span>
<span>  conceptFilter <span class="op">=</span> <span class="fl">3027018</span>,</span>
<span>  columnFilter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"measurement_date"</span>, <span class="st">"value_as_number"</span><span class="op">)</span>,</span>
<span>  wideLongitudinal <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  completeTimePoints <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ds.summary</span><span class="op">(</span><span class="st">"measurement"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## $opal_demo</span></span>
<span><span class="co">## $opal_demo$class</span></span>
<span><span class="co">## [1] "data.frame"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $opal_demo$`number of rows`</span></span>
<span><span class="co">## [1] 100</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $opal_demo$`number of columns`</span></span>
<span><span class="co">## [1] 9099</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $opal_demo$`variables held`</span></span>
<span><span class="co">##  [1] "person_id"                     "heart_rate.1.measurement_date"</span></span>
<span><span class="co">##  [3] "heart_rate.1.value_as_number"  "heart_rate.2.measurement_date"</span></span>
<span><span class="co">##  [5] "heart_rate.2.value_as_number"  "heart_rate.3.measurement_date"</span></span>
<span><span class="co">##  [7] "heart_rate.3.value_as_number"  "heart_rate.4.measurement_date"</span></span>
<span><span class="co">##  [9] "heart_rate.4.value_as_number"  "heart_rate.5.measurement_date"</span></span>
<span><span class="co">##  [ reached getOption("max.print") -- omitted 9089 entries ]</span></span></code></pre>
<p>Because DataSHIELD does not allow row-level inspection on the client
side, you will not see the exact final structure of the data.
Internally, however, <code>dsOMOP</code> arranges your dataset so that
every individual is aligned on a consistent time axis. Below is a
simplified illustration of how this reshaping would look for a small
example of three patients (A, B, C). It does <em>not</em> reflect real
data—merely a conceptual snapshot.</p>
<hr>
<p><strong>Case 1: <code>wideLongitudinal = TRUE</code> but
<code>completeTimePoints = FALSE</code></strong></p>
<p>In this scenario, <code>dsOMOP</code> just generates a wide table
indexed by the <em>chronological order</em> of each patient’s events. It
does <em>not</em> force every patient to share the same time points.
Suppose the patients have data as follows:</p>
<ul>
<li>Patient A has 3 heart-rate measurements (Dates: 2023-01-01,
2023-01-15, 2023-01-31)</li>
<li>Patient B has 2 measurements (Dates: 2023-01-01, 2023-01-02)</li>
<li>Patient C has 1 measurement (Date: 2023-01-10)</li>
</ul>
<p>The resulting table, conceptually, might look like this:</p>
<table class="table">
<colgroup>
<col width="5%">
<col width="15%">
<col width="15%">
<col width="15%">
<col width="15%">
<col width="15%">
<col width="15%">
</colgroup>
<thead><tr class="header">
<th>person_id</th>
<th>heart_rate.measurement_date.1</th>
<th>heart_rate.measurement_value.1</th>
<th>heart_rate.measurement_date.2</th>
<th>heart_rate.measurement_value.2</th>
<th>heart_rate.measurement_date.3</th>
<th>heart_rate.measurement_value.3</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>A</td>
<td>2023-01-01</td>
<td>70</td>
<td>2023-01-15</td>
<td>71</td>
<td>2023-01-31</td>
<td>72</td>
</tr>
<tr class="even">
<td>B</td>
<td>2023-01-01</td>
<td>60</td>
<td>2023-01-02</td>
<td>65</td>
<td>NA</td>
<td>NA</td>
</tr>
<tr class="odd">
<td>C</td>
<td>2023-01-10</td>
<td>67</td>
<td>NA</td>
<td>NA</td>
<td>NA</td>
<td>NA</td>
</tr>
</tbody>
</table>
<ul>
<li>Columns “.1”, “.2”, “.3” represent <em>the 1st, 2nd, and 3rd
measurement</em> recorded for each patient, in that patient’s
<em>own</em> chronological order.</li>
<li>If a patient doesn’t have a second or third measurement, those
columns are <code>NA</code>.</li>
<li>Different patients can have entirely different date values in, say,
<code>.2</code> or <code>.3</code>.</li>
</ul>
<hr>
<p><strong>Case 2: <code>wideLongitudinal = TRUE</code> and
<code>completeTimePoints = TRUE</code></strong></p>
<p>Now <code>dsOMOP</code> additionally ensures that <em>all</em>
patients align on <em>every</em> time point found across all patients in
the dataset. For instance, if the union of dates in your dataset is
<code>{2023-01-01, 2023-01-02, 2023-01-10, 2023-01-15, 2023-01-31}</code>,
then each row (i.e., each patient) will have columns for <em>five</em>
distinct measurements, even if some are <code>NA</code>:</p>
<table style="width:100%;" class="table">
<colgroup>
<col width="3%">
<col width="9%">
<col width="9%">
<col width="9%">
<col width="9%">
<col width="9%">
<col width="9%">
<col width="9%">
<col width="9%">
<col width="9%">
<col width="9%">
</colgroup>
<thead><tr class="header">
<th>person_id</th>
<th>heart_rate.measurement_date.1</th>
<th>heart_rate.measurement_value.1</th>
<th>heart_rate.measurement_date.2</th>
<th>heart_rate.measurement_value.2</th>
<th>heart_rate.measurement_date.3</th>
<th>heart_rate.measurement_value.3</th>
<th>heart_rate.measurement_date.4</th>
<th>heart_rate.measurement_value.4</th>
<th>heart_rate.measurement_date.5</th>
<th>heart_rate.measurement_value.5</th>
</tr></thead>
<tbody>
<tr class="odd">
<td>A</td>
<td>2023-01-01</td>
<td>70</td>
<td>NA</td>
<td>NA</td>
<td>2023-01-15</td>
<td>71</td>
<td>NA</td>
<td>NA</td>
<td>2023-01-31</td>
<td>72</td>
</tr>
<tr class="even">
<td>B</td>
<td>2023-01-01</td>
<td>60</td>
<td>2023-01-02</td>
<td>65</td>
<td>NA</td>
<td>NA</td>
<td>NA</td>
<td>NA</td>
<td>NA</td>
<td>NA</td>
</tr>
<tr class="odd">
<td>C</td>
<td>NA</td>
<td>NA</td>
<td>NA</td>
<td>NA</td>
<td>2023-01-10</td>
<td>67</td>
<td>NA</td>
<td>NA</td>
<td>NA</td>
<td>NA</td>
</tr>
</tbody>
</table>
<ul>
<li>For privacy reasons, it <em>still</em> uses index-based columns
(e.g., <code>.1, .2, .3</code>), but now behind the scenes, each suffix
corresponds to the <em>same date</em> for every patient.</li>
<li>Patients missing a measurement on a particular date have
<code>NA</code> in both the <code>measurement_date</code> and
<code>measurement_value</code> columns for that slot.</li>
<li>This approach ensures a consistent date axis across all individuals,
which is typically needed for time-series analysis or for creating
time-aligned comparisons.</li>
</ul>
<hr>
<div class="section level5">
<h5 id="practical-usage-notes">Practical usage notes<a class="anchor" aria-label="anchor" href="#practical-usage-notes"></a>
</h5>
<ol style="list-style-type: decimal">
<li>
<strong>Date sorting</strong>: Under the hood,
<strong>dsOMOP</strong> first discovers all unique dates in the data,
sorts them in ascending order, and then indexes them as
<code>.1, .2, .3, …</code>.</li>
<li>
<strong>Flexibility</strong>: You can still opt <em>not</em> to
align time points by leaving <code>completeTimePoints</code> as
<code>FALSE</code>. This can be useful for scenarios where each
patient’s internal timeline is more relevant than a global date
alignment.</li>
<li>
<strong>Merging</strong>: Whether you choose to use alignment or
not, your wide-format table remains mergeable with other wide-format
tables in DataSHIELD if they share the same <code>person_id</code> (or
whichever merge column(s) you specify).</li>
</ol>
<p>In short, <code>wideLongitudinal</code> provides a wide “spread” of
repeated measurements within each row, and
<code>completeTimePoints</code> ensures that these measurements line up
on a shared calendar of dates. You can fine-tune these parameters to
suit your analytic design.</p>
</div>
</div>
</div>
<div class="section level2">
<h2 id="using-the-get-method">2.2 Using the <code>get</code> method<a class="anchor" aria-label="anchor" href="#using-the-get-method"></a>
</h2>
<p>The <code>get</code> method has several arguments that allow for the
customization of the data that is retrieved. These arguments are:</p>
<ul>
<li>
<code>table</code>: the name of the table to be retrieved.</li>
<li>
<code>symbol</code>: the name of the symbol that will be used to
store the table in the server’s R environment. If not specified, the
table will be stored in a symbol with the same name as the table.</li>
<li>
<code>conceptFilter</code>: a numeric vector with the concept IDs to
be retrieved. It can also be a single numeric value.</li>
<li>
<code>columnFilter</code>: a character vector with the names of the
columns to be retrieved. It can also be a single character value.</li>
<li>
<code>personFilter</code>: the name of another symbol in the
server’s R environment which contains the person IDs to be retrieved by
the current <code>get</code> operation. If not specified, all existing
person IDs will be retrieved.</li>
<li>
<code>mergeColumn</code>: the name of the column that will be used
to merge the table with another table. If not specified, the
<code>person_id</code> column will be used as the default merge
column.</li>
<li>
<code>dropNA</code>: a logical value indicating whether empty
columns should be automatically filtered out from the table. The default
value is <code>TRUE</code>.</li>
</ul>
<p>Note that only the <code>table</code> parameter is mandatory for
retrieving a table. However, it is highly recommended to utilize the
available data filtering parameters, as they can significantly enhance
the performance of operations and ensure that only the relevant data for
your study is selected.</p>
<div class="section level3">
<h3 id="applying-basic-filters">2.2.1 Applying basic filters<a class="anchor" aria-label="anchor" href="#applying-basic-filters"></a>
</h3>
<p>This part is quite straightforward. We use the <code>tables()</code>
command to know which tables we can take, <code>columns()</code> to know
what columns we have available, and <code>concepts()</code> to
understand what concepts are present as entities in the table and select
those we wish to work with.</p>
<p>Once we have identified the specific data we are interested in
analyzing, we can apply the <code>columnFilter</code> and
<code>conceptFilter</code> parameters to retrieve the desired
<code>table</code>.</p>
<p>Let’s proceed with an example.</p>
<p>We check the available tables:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">o</span><span class="op">$</span><span class="fu">tables</span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## $opal_demo</span></span>
<span><span class="co">##  [1] "attribute_definition" "care_site"            "cdm_source"          </span></span>
<span><span class="co">##  [4] "cohort"               "cohort_attribute"     "cohort_definition"   </span></span>
<span><span class="co">##  [7] "concept"              "concept_relationship" "condition_era"       </span></span>
<span><span class="co">## [10] "condition_occurrence" "cost"                 "death"               </span></span>
<span><span class="co">## [13] "device_exposure"      "dose_era"             "drug_era"            </span></span>
<span><span class="co">## [16] "drug_exposure"        "fact_relationship"    "location"            </span></span>
<span><span class="co">## [19] "measurement"          "metadata"             "note"                </span></span>
<span><span class="co">## [22] "note_nlp"             "observation"          "observation_period"  </span></span>
<span><span class="co">## [25] "payer_plan_period"    "person"               "procedure_occurrence"</span></span>
<span><span class="co">## [28] "provider"             "specimen"             "visit_detail"        </span></span>
<span><span class="co">## [31] "visit_occurrence"     "vocabulary"</span></span></code></pre>
<p>Let’s say we want to retrieve some measurements from the
<code>Measurement</code> table. We can use the <code>concepts()</code>
command to see what concepts are available in this table:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">o</span><span class="op">$</span><span class="fu">concepts</span><span class="op">(</span><span class="st">"measurement"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## $opal_demo</span></span>
<span><span class="co">##   concept_id                                       concept_name</span></span>
<span><span class="co">## 1          0                                No matching concept</span></span>
<span><span class="co">## 2    1175625                            Breath rate spontaneous</span></span>
<span><span class="co">## 3    3000067 Parathyrin.intact [Mass/volume] in Serum or Plasma</span></span>
<span><span class="co">## 4    3000068                      oxyCODONE [Presence] in Urine</span></span>
<span><span class="co">## 5    3000099  Nuclear Ab [Units/volume] in Serum by Immunoassay</span></span>
<span><span class="co">##  [ reached 'max' / getOption("max.print") -- omitted 348 rows ]</span></span></code></pre>
<p>We have decided to retrieve the information related to the concept
<code>3010421</code> (which corresponds to
<code>pH of blood</code>).</p>
<p>But we don’t want to retrieve all the columns from the table, so we
can use the <code>columns()</code> command to see what columns are
available in the <code>Measurement</code> table:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">o</span><span class="op">$</span><span class="fu">columns</span><span class="op">(</span><span class="st">"measurement"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## $opal_demo</span></span>
<span><span class="co">##  [1] "measurement_id"                "person_id"                    </span></span>
<span><span class="co">##  [3] "measurement_concept_id"        "measurement_date"             </span></span>
<span><span class="co">##  [5] "measurement_datetime"          "measurement_time"             </span></span>
<span><span class="co">##  [7] "measurement_type_concept_id"   "operator_concept_id"          </span></span>
<span><span class="co">##  [9] "value_as_number"               "value_as_concept_id"          </span></span>
<span><span class="co">## [11] "unit_concept_id"               "range_low"                    </span></span>
<span><span class="co">## [13] "range_high"                    "provider_id"                  </span></span>
<span><span class="co">## [15] "visit_occurrence_id"           "visit_detail_id"              </span></span>
<span><span class="co">## [17] "measurement_source_value"      "measurement_source_concept_id"</span></span>
<span><span class="co">## [19] "unit_source_value"             "value_source_value"</span></span></code></pre>
<p>We are only interested in the <code>measurement_date</code> and
<code>value_as_number</code> from the <code>Measurement</code> table
related to the concept ID <code>3010421</code>. We can use the
<code>get</code> method to retrieve this information:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">o</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span>table <span class="op">=</span> <span class="st">"measurement"</span>,  <span class="co"># The table we want to retrieve</span></span>
<span>      symbol <span class="op">=</span> <span class="st">"my_table"</span>,  <span class="co"># The name of the symbol that will store the table</span></span>
<span>      conceptFilter <span class="op">=</span> <span class="fl">3010421</span>,  <span class="co"># The concept we are interested in</span></span>
<span>      columnFilter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"measurement_date"</span>, <span class="st">"value_as_concept_id"</span><span class="op">)</span>,  <span class="co"># The only columns we want to retrieve</span></span>
<span>      dropNA <span class="op">=</span> <span class="cn">FALSE</span>  <span class="co"># Whether we want to drop empty columns or not</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ds.summary</span><span class="op">(</span><span class="st">"my_table"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## $opal_demo</span></span>
<span><span class="co">## $opal_demo$class</span></span>
<span><span class="co">## [1] "data.frame"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $opal_demo$`number of rows`</span></span>
<span><span class="co">## [1] 78</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $opal_demo$`number of columns`</span></span>
<span><span class="co">## [1] 3</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $opal_demo$`variables held`</span></span>
<span><span class="co">## [1] "person_id"                       "ph_of_blood.measurement_date"   </span></span>
<span><span class="co">## [3] "ph_of_blood.value_as_concept_id"</span></span></code></pre>
<p>Now this information is ready to be used within the DataSHIELD
environment for any analysis or data manipulation operations that we
want to perform. In the next chapter, we will see how to use the
built-in functions of DataSHIELD’s <code>dsBaseClient</code> package to
combine it with other tables.</p>
</div>
<div class="section level3">
<h3 id="selecting-a-merge-column">2.2.2 Selecting a merge column<a class="anchor" aria-label="anchor" href="#selecting-a-merge-column"></a>
</h3>
<p>When retrieving a table, it is possible to specify a column that will
be used to merge the table with another table. This is done using the
<code>mergeColumn</code> argument. For example, when retrieving the
<code>Visit_detail</code> table, we can specify that the column
<code>visit_occurrence_id</code> will be used to merge this table with
the <code>Visit_occurrence</code> table, and it will perform the
reshaping operation to make this merge possible.</p>
<p>For this example, we will retrieve the <code>Visit_detail</code>
table related to the concept ID <code>4149943</code> (which corresponds
to <code>Cardiac intensive care unit</code>, meaning that we are
interested in retrieving only the visits to this unit):</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">o</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span>table <span class="op">=</span> <span class="st">"visit_detail"</span>,</span>
<span>      conceptFilter <span class="op">=</span> <span class="fl">4149943</span>,  <span class="co"># `Cardiac intensive care unit`</span></span>
<span>      columnFilter <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"visit_detail_start_date"</span>, <span class="st">"visit_detail_end_date"</span><span class="op">)</span>,</span>
<span>      mergeColumn <span class="op">=</span> <span class="st">"visit_occurrence_id"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ds.summary</span><span class="op">(</span><span class="st">"visit_detail"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## $opal_demo</span></span>
<span><span class="co">## $opal_demo$class</span></span>
<span><span class="co">## [1] "data.frame"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $opal_demo$`number of rows`</span></span>
<span><span class="co">## [1] 39</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $opal_demo$`number of columns`</span></span>
<span><span class="co">## [1] 4</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $opal_demo$`variables held`</span></span>
<span><span class="co">## [1] "visit_occurrence_id"                                </span></span>
<span><span class="co">## [2] "cardiac_intensive_care_unit.person_id"              </span></span>
<span><span class="co">## [3] "cardiac_intensive_care_unit.visit_detail_start_date"</span></span>
<span><span class="co">## [4] "cardiac_intensive_care_unit.visit_detail_end_date"</span></span></code></pre>
<p>If no <code>mergeColumn</code> is specified, the <code>get</code>
method will assume <code>person_id</code> as the default merge column,
as this is the most common column that is used to merge tables in an
OMOP CDM database.</p>
</div>
<div class="section level3">
<h3 id="filtering-by-person-ids">2.2.3 Filtering by person IDs<a class="anchor" aria-label="anchor" href="#filtering-by-person-ids"></a>
</h3>
<p>The <code>personFilter</code> argument allows for the retrieval of
data for a specific subset of person IDs. This can be useful when
working with a large dataset and only needing to retrieve data for a
specific group of individuals.</p>
<p>To use the <code>personFilter</code> parameter, we have to specify
the symbol of another table that already exists in the R environment.
This referenced table has to contain <code>person_id</code> values that
may represent a subset of the <code>person_id</code> values in the table
that we aim to retrieve. By applying this parameter, the retrieval
process filters the target table to include only records corresponding
to the <code>person_id</code> values present in the referenced table,
thereby excluding any records associated with <code>person_id</code>
values not contained in the referenced table.</p>
<p>Utilizing the subsetting functions provided by the
<code>dsBaseClient</code> package can significantly enhance the
versatility of filtering database records based on cohorts, conditions,
or any other characteristics defining a subset of individuals.
Furthermore, the <code>dsOMOP</code> package implements a disclosure
control process that prevents the retrieval of tables containing
information on a number of patients below a predefined threshold set in
the server’s configuration. This ensures the security and
confidentiality of the data at all times.</p>
<p>Let’s perform a simple example to illustrate the potential of this
feature.</p>
<p>Suppose that, in this case, we are interested in analyzing data from
patients who have records of the condition <code>Chest pain</code>
(Concept ID <code>77670</code> in <code>Condition_occurrence</code>). We
can save this information to a specific <code>symbol</code> and then
pass it as the <code>personFilter</code> argument to the
<code>get</code> method for the <code>Person</code> table:</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">o</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span>table <span class="op">=</span> <span class="st">"condition_occurrence"</span>,</span>
<span>      conceptFilter <span class="op">=</span> <span class="fl">77670</span>,  <span class="co"># `Chest pain`</span></span>
<span>      columnFilter <span class="op">=</span> <span class="st">"condition_start_date"</span>,</span>
<span>      symbol <span class="op">=</span> <span class="st">"chest_pain_condition"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ds.summary</span><span class="op">(</span><span class="st">"chest_pain_condition"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## $opal_demo</span></span>
<span><span class="co">## $opal_demo$class</span></span>
<span><span class="co">## [1] "data.frame"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $opal_demo$`number of rows`</span></span>
<span><span class="co">## [1] 4</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $opal_demo$`number of columns`</span></span>
<span><span class="co">## [1] 2</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $opal_demo$`variables held`</span></span>
<span><span class="co">## [1] "person_id"                       "chest_pain.condition_start_date"</span></span></code></pre>
<p>We stored the measurements under the
<code>chest_pain_condition</code> symbol. Now we can use this table
(referenced through the <code>chest_pain_condition</code> symbol) to
filter the <code>Person</code> table and retrieve only the data related
to these patients:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">o</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span>table <span class="op">=</span> <span class="st">"person"</span>,</span>
<span>      symbol <span class="op">=</span> <span class="st">"person_with_chest_pain"</span>,  <span class="co"># The name of the symbol that will store the table</span></span>
<span>      personFilter <span class="op">=</span> <span class="st">"chest_pain_condition"</span><span class="op">)</span>  <span class="co"># The symbol that contains the only person IDs to be retrieved</span></span></code></pre></div>
<p>Now we have a subset of the <code>Person</code> table that only
contains the data related to the patients who have records of the
condition <code>Chest pain</code>, stored in the
<code>person_with_chest_pain</code> symbol. We can pass it to the
<code>personFilter</code> argument of the <code>get</code> method for a
third table to retrieve only the data related to these patients. For
example, we can retrieve the <code>Observation</code> table using the
<code>person_with_chest_pain</code> symbol as the
<code>personFilter</code>, and it will only retrieve the data related to
the the patients who are present in the
<code>person_with_chest_pain</code> symbol:</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">o</span><span class="op">$</span><span class="fu">get</span><span class="op">(</span>table <span class="op">=</span> <span class="st">"observation"</span>,</span>
<span>      symbol <span class="op">=</span> <span class="st">"observation_from_person_with_chest_pain"</span>,</span>
<span>      columnFilter <span class="op">=</span> <span class="st">"observation_date"</span>,</span>
<span>      personFilter <span class="op">=</span> <span class="st">"person_with_chest_pain"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">ds.summary</span><span class="op">(</span><span class="st">"observation_from_person_with_chest_pain"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## $opal_demo</span></span>
<span><span class="co">## $opal_demo$class</span></span>
<span><span class="co">## [1] "data.frame"</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $opal_demo$`number of rows`</span></span>
<span><span class="co">## [1] 4</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $opal_demo$`number of columns`</span></span>
<span><span class="co">## [1] 15</span></span>
<span><span class="co">## </span></span>
<span><span class="co">## $opal_demo$`variables held`</span></span>
<span><span class="co">##  [1] "person_id"                                           </span></span>
<span><span class="co">##  [2] "primary_insurance.observation_date"                  </span></span>
<span><span class="co">##  [3] "preferred_language.observation_date"                 </span></span>
<span><span class="co">##  [4] "cost_containment.observation_date"                   </span></span>
<span><span class="co">##  [5] "pain_severity_reported.observation_date"             </span></span>
<span><span class="co">##  [6] "acceptable_pain_level_status.observation_date"       </span></span>
<span><span class="co">##  [7] "indicators_of_pain_or_possible_pain.observation_date"</span></span>
<span><span class="co">##  [8] "body_temperature_measurement_site.observation_date"  </span></span>
<span><span class="co">##  [9] "pain_management_specialty.observation_date"          </span></span>
<span><span class="co">## [10] "bowel_sounds.observation_date"                       </span></span>
<span><span class="co">##  [ reached getOption("max.print") -- omitted 5 entries ]</span></span></code></pre>
<p>The <code>Observation</code> table we retrieved only contains all the
observation records related to the patients who have records of the
condition <code>Chest pain</code>.</p>
<p>This way, we can easily filter the data we are interested in and work
with a subset of the data that is relevant to our study. This can also
be done with cohorts, conditions, and any other characteristics that
define a subset of individuals. It is done at query time, which makes
data retrieval efficient.</p>
<p>In the next article, we will see how to use the
<code>dsBaseClient</code> package to combine the data we have retrieved
to create a combined dataset that can be used for analysis.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



   </div>
  <footer><div class="container">
  <div class="pkgdown-footer-left">
  <p>Developed by <a href="https://github.com/davidsarratgonzalez" class="external-link">David Sarrat González</a>, <a href="https://github.com/ESCRI11" class="external-link">Xavier Escribà-Montagut</a>, <a href="https://github.com/isglobal-brge" class="external-link">Juan R González</a>.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

  </div></footer>
</body>
</html>
